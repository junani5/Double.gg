from flask import Flask, request, jsonify
from flask_cors import CORS

# Flask ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”
app = Flask(__name__)

# -------------------------------------------------------------------
# CORS ì„¤ì •: Next.jsê°€ ì‹¤í–‰ë˜ëŠ” http://localhost:3000 ì—ì„œ ì˜¤ëŠ” 
# '/predict_offset' ê²½ë¡œì˜ ìš”ì²­ì„ í—ˆìš©í•©ë‹ˆë‹¤.
# -------------------------------------------------------------------
CORS(app, resources={r"/predict_offset": {"origins": "http://localhost:3000"}})


# -------------------------------------------------------------------
# 1. ê°œì¸ ë§ì¶¤ ì¶”ì²œ ë¡œì§ (ë”ë¯¸ ML ëª¨ë¸)
# -------------------------------------------------------------------
def predict_offset(user_id: str, temp: float) -> float:
    """
    ì‚¬ìš©ì IDì™€ í˜„ì¬ ê¸°ì˜¨ì„ ê¸°ë°˜ìœ¼ë¡œ ì˜¨ë„ ë³´ì • ê°’(Offset)ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
    
    ì˜¤í”ˆì†ŒìŠ¤ ê³¼ì œì˜ ë‹¤ìŒ ë‹¨ê³„ì—ì„œëŠ”, ì´ í•¨ìˆ˜ë¥¼ 
    'scikit-learnìœ¼ë¡œ í•™ìŠµëœ ëª¨ë¸(.pkl)ì„ ë¡œë“œí•˜ì—¬ ì˜ˆì¸¡í•˜ëŠ”' 
    ì‹¤ì œ ML ë¡œì§ìœ¼ë¡œ ëŒ€ì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
    ë°˜í™˜ ê°’:
    - ìŒìˆ˜(-): ì¶”ìœ„ë¥¼ ë§ì´ íƒ€ëŠ” ì‚¬ìš©ì (ë” ë‘êº¼ìš´ ì˜· ì¶”ì²œ)
    - ì–‘ìˆ˜(+): ë”ìœ„ë¥¼ ë§ì´ íƒ€ëŠ” ì‚¬ìš©ì (ë” ì–‡ì€ ì˜· ì¶”ì²œ)
    - 0: ê¸°ë³¸ ì‚¬ìš©ì
    """
    
    # [ì„ì‹œ ê·œì¹™ ê¸°ë°˜ ë³´ì • ì˜ˆì‹œ]
    # ë‚˜ì¤‘ì— ì´ user_idëŠ” Next.jsê°€ ì‹¤ì œ ë¡œê·¸ì¸ ì‹œìŠ¤í…œì—ì„œ ë°›ì•„ì™€ì•¼ í•©ë‹ˆë‹¤.
    
    if user_id == "cold_sensitive_user":
        # 'ì¶”ìœ„ë¥¼ ë§ì´ íƒ€ëŠ” ì‚¬ìš©ì'ë¡œ ê°€ì •
        # ì‹¤ì œ ì˜¨ë„ë³´ë‹¤ 2ë„ ë‚®ê²Œ ë³´ì •í•˜ì—¬ ë” ë‘êº¼ìš´ ì˜·ì„ ì¶”ì²œí•˜ë„ë¡ í•¨
        print(f"ë¡œê·¸: {user_id}ë‹˜ (ì¶”ìœ„ íƒ€ëŠ” ë¶„) -2.0ë„ ë³´ì • ì ìš©")
        return -2.0
    
    elif user_id == "hot_sensitive_user":
        # 'ë”ìœ„ë¥¼ ë§ì´ íƒ€ëŠ” ì‚¬ìš©ì'ë¡œ ê°€ì •
        # ì‹¤ì œ ì˜¨ë„ë³´ë‹¤ 1.5ë„ ë†’ê²Œ ë³´ì •í•˜ì—¬ ë” ì–‡ì€ ì˜·ì„ ì¶”ì²œí•˜ë„ë¡ í•¨
        print(f"ë¡œê·¸: {user_id}ë‹˜ (ë”ìœ„ íƒ€ëŠ” ë¶„) +1.5ë„ ë³´ì • ì ìš©")
        return 1.5
    
    else:
        # 'anonymous' ë˜ëŠ” ê¸°íƒ€ ê¸°ë³¸ ì‚¬ìš©ì
        print(f"ë¡œê·¸: {user_id}ë‹˜ (ê¸°ë³¸ ì‚¬ìš©ì) 0.0ë„ ë³´ì • ì ìš©")
        return 0.0

# -------------------------------------------------------------------
# 2. API ì—”ë“œí¬ì¸íŠ¸ ì •ì˜
# -------------------------------------------------------------------
@app.route('/predict_offset', methods=['POST'])
def predict():
    """
    Next.js ë°±ì—”ë“œ(/api/weather/route.ts)ë¡œë¶€í„° 
    'userId'ì™€ 'currentTemp'ë¥¼ ë°›ì•„ ë³´ì • ê°’ì„ ë°˜í™˜í•˜ëŠ” API
    """
    try:
        # Next.jsê°€ ë³´ë‚¸ JSON ë°ì´í„° ë°›ê¸°
        data = request.get_json()
        
        # ë°ì´í„° ì¶”ì¶œ (ê¸°ë³¸ê°’ 'anonymous' ì„¤ì •)
        user_id = data.get('userId', 'anonymous')
        temp = data.get('currentTemp')
        
        # í•„ìˆ˜ ê°’(í˜„ì¬ ê¸°ì˜¨) í™•ì¸
        if temp is None:
            return jsonify({'error': 'Bad Request: currentTemp is required'}), 400

        # 1ë²ˆì˜ ë”ë¯¸ ëª¨ë¸ í•¨ìˆ˜ í˜¸ì¶œ
        offset = predict_offset(user_id, temp)
        
        # Next.jsë¡œ ë³´ì • ê°’(Offset)ì„ JSON í˜•íƒœë¡œ ë°˜í™˜
        return jsonify({
            'userId': user_id,
            'temperatureOffset': offset 
        })
        
    except Exception as e:
        # ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ ë°œìƒ ì‹œ
        print(f"ML ì„œë²„ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return jsonify({'error': f'Internal Server Error: {str(e)}'}), 500

# -------------------------------------------------------------------
# 3. Flask ì„œë²„ ì‹¤í–‰
# -------------------------------------------------------------------
if __name__ == '__main__':
    print("========================================")
    print("ğŸ’¡ ML ì„œë²„ê°€ http://127.0.0.1:5000 ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤...")
    print("========================================")
    # Next.js(3000ë²ˆ)ì™€ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡ 5000ë²ˆ í¬íŠ¸ ì‚¬ìš©
    # debug=Trueë¡œ ì„¤ì •í•˜ì—¬ ì½”ë“œ ìˆ˜ì • ì‹œ ì„œë²„ê°€ ìë™ ì¬ì‹œì‘ë©ë‹ˆë‹¤.
    app.run(host='0.0.0.0', port=5000, debug=True)